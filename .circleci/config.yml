version: 2.1

jobs:
  multiverse-test:
    docker:
      - image: cimg/node:20.11
    steps:
      - checkout

      - run:
          name: Install dependencies
          command: npx pnpm install

      - run:
          name: Run Multiverse tests
          command: npx pnpm test:flight
          environment:
            MULTIVERSE_URL: https://multiverse-vqjj.onrender.com
            # ANTHROPIC_API_KEY is set in CircleCI project settings
            # PR comments are posted via multiverse-bot (no GITHUB_TOKEN needed)

workflows:
  test:
    jobs:
      - multiverse-test:
          context:
            - multiverse  # CircleCI context with ANTHROPIC_API_KEY
          filters:
            branches:
              ignore:
                - main  # Only run on PR branches, not main
